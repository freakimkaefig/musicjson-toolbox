!function(){"use strict"
var t={base12:{C:1,D:3,E:5,F:6,G:8,A:10,B:12},base12Inverted:{1:"C",3:"D",5:"E",6:"F",8:"G",10:"A",12:"B"},degreesFromSemitones:{1:1,3:2,5:3,6:4,8:5,10:6,12:7},deg:{0:0,1:.9,2:.2,3:.5,4:.1,5:.35,6:.8},ton:{0:.6,1:2.6,2:2.3,3:1,4:1,5:1.6,6:1.8,7:.8,8:1.3,9:1.3,10:2.2,11:2.5},globalK:.348,abcStep:["C,,,","^C,,,","D,,,","^D,,,","E,,,","F,,,","^F,,,","G,,,","^G,,,","A,,,","^A,,,","B,,,","C,,","^C,,","D,,","^D,,","E,,","F,,","^F,,","G,,","^G,,","A,,","^A,,","B,,","C,","^C,","D,","^D,","E,","F,","^F,","G,","^G,","A,","^A,","B,","C","^C","D","^D","E","F","^F","G","^G","A","^A","B","c","^c","d","^d","e","f","^f","g","^g","a","^a","b","c'","^c'","d'","^d'","e'","f'","^f'","g'","^g'","a'","^a'","b'","c''","^c''","d''","^d''","e''","f''","^f''","g''","^g''","a''","^a''","b''","c'''","^c'''","d'''","^d'''","e'''","f'''","^f'''","g'''","^g'''","a'''","^a'''","b'''"],abcAccidental:{"flat-flat":"__",flat:"_",natural:"=",sharp:"^","sharp-sharp":"^^",undefined:"","":""},notes:function(t,e,n){for(var i=[],r=-1,a=0;a<t.measures.length;a++){for(var s=0;s<t.measures[a].notes.length;s++)t.measures[a].notes[s].measureNumber=a,t.measures[a].notes[s].noteNumber=s
if(e&&t.measures[a].attributes.repeat.left&&(r=a),i=i.concat(t.measures[a].notes),e&&t.measures[a].attributes.repeat.right){if(-1!==r)for(;a>=r;)i=i.concat(t.measures[r].notes),r++
r=-1}}for(var u=0;u<i.length;u++)i[u].rest!==!0&&"true"!==i[u].rest||n!==!1||i.splice(u,1)
return i},intervals:function(t){var e=[]
e.push({value:"*",duration:"*",noteNumber:0,measureNumber:0})
for(var n=1;n<t.length;n++){var i=this.pitchDifference(t[n-1].pitch,0,t[n].pitch,!0,!1),r={value:i,duration:this.durationDifference(t[n-1].duration,t[n].duration),noteNumber:t[n].noteNumber,measureNumber:t[n].measureNumber}
e.push(r)}return e},parsons:function(t){var e=[]
e.push({value:"*",noteNumber:0,measureNumber:0})
for(var n=1;n<t.length;n++){var i,r=this.pitchDifference(t[n-1].pitch,0,t[n].pitch,!0,!1)
0===r?i="r":r>0?i="u":0>r&&(i="d"),e.push({value:i,noteNumber:t[n].noteNumber,measureNumber:t[n].measureNumber})}return e},ngrams:function(t,e){for(var n=[],i=0;i<t.length-(e-1);i++){for(var r=[],a=0;e>a;a++)r.push(t[i+a])
n.push(r)}return n},pitchValues:function(t,e){return t.map(function(t){return this.base12Pitch(t.pitch.step,e,t.pitch.octave,t.pitch.alter,!1)}.bind(this))},pitchDurationValues:function(t,e,n,i){return t.map(function(t){return{value:this.base12Pitch(t.pitch.step,e,t.pitch.octave,t.pitch.alter,!1),rest:t.rest,duration:t.duration/n/i*16}}.bind(this))},tempoAdjust:function(t,e){for(var n=[],i=0;i<t.length;i++){var r=t[i]
r.duration=e(r.duration),n.push(r)}return n},highlightMapping:function(t){return t.map(function(t){return{measure:t.measureNumber,note:t.noteNumber}})},base12Pitch:function(t,e,n,i,r){var a=this.base12[t]
if(i&&(a+=i),0>e)for(a-=12*Math.round(Math.abs(e)/2);0>e;)a+=7,e++
else for(a+=12*Math.round(Math.abs(e)/2);e>0;)a-=7,e--
if(0===a&&(a=12,n--),r)a+=12*n
else{for(;a>12;)a-=12
for(;0>a;)a+=12}return a},interval2AbcStep:function(t,e){return this.abcStep[e+t-13]},pitchDuration2AbcStep:function(t,e){var n=this.abcAccidental[t.pitch.accidental],i=this.abcStep[this.base12Pitch(t.pitch.step,0,t.pitch.octave,0,!0)-13],r=t.duration
null!==e&&e.dot&&(r=2*r)
var a=""
return t.dot&&(r/=1.5,a=">"),t.rest?"z"+r+a:n+i+r+a},pitchDifference:function(t,e,n,i,r){"undefined"==typeof i&&(i=!1),"undefined"==typeof r&&(r=!1)
var a=this.base12Pitch(n.step,e,parseInt(n.octave),parseInt(n.alter),i)-this.base12Pitch(t.step,e,parseInt(t.octave),parseInt(t.alter),i)
return r&&(a=Math.abs(a)),a},durationDifference:function(t,e,n){"undefined"==typeof n&&(n=!1)
var i=e-t
return n&&(i=Math.abs(i)),i},uniques:function(t){for(var e=[],n=0,i=t.length;i>n;n++)-1===e.indexOf(t[n])&&""!==t[n]&&e.push(t[n])
return e},editDistance:function(t,e,n,i){if(0===t.length)return e.length
if(0===e.length)return t.length
var r,a=[]
for(r=0;r<=e.length;r++)a[r]=[r]
var s
for(s=0;s<=t.length;s++)a[0][s]=s
for(r=1;r<=e.length;r++)for(s=1;s<=t.length;s++)n(r,s)?a[r][s]=a[r-1][s-1]:a[r][s]=Math.min(a[r-1][s-1]+i(r,s),a[r][s-1]+i(r,s),a[r-1][s]+i(r,s))
return a[e.length][t.length]},stringEditDistance:function(t,e){return this.editDistance(t,e,function(n,i){return e.charAt(n-1)===t.charAt(i-1)},function(){return 1})},arrayEditDistance:function(t,e){return this.editDistance(t,e,function(n,i){return e[n-1]===t[i-1]},function(){return 1})},weightedEditDistance:function(t,e){var n,i=[]
for(n=0;n<=t.length;n++)n>0?i[n]=[parseFloat(i[n-1])+this.weightDeletion(t,n)]:i[n]=[n]
var r
for(r=0;r<=e.length;r++)r>0?i[0][r]=parseFloat(i[0][r-1])+this.weightInsertion(e,r):i[0][r]=r
var a=0,s=1/0
for(n=0;n<t.length;n++)a<t[n].duration&&(a=t[n].duration)
for(r=0;r<e.length;r++)s>e[r].duration&&(s=e[r].duration)
var u=a/s,h=0,o=1/0
for(r=0;r<e.length;r++)h<e[r].duration&&(h=e[r].duration)
for(n=0;n<t.length;n++)o>t[n].duration&&(o=t[n].duration)
var f=h/o
for(n=1;n<=t.length;n++)for(r=1;r<=e.length;r++)if(t[n-1].value===e[r-1].value&&t[n-1].rest===e[r-1].rest&&t[n-1].duration===e[r-1].duration)i[n][r]=i[n-1][r-1]
else{var c=i[n-1][r-1]+this.weightSubstitution(t,e,n,r),l=i[n][r-1]+this.weightInsertion(e,r),g=i[n-1][r]+this.weightDeletion(t,n),d=this.weightFragmentation(i,t,e,n,r,u),p=this.weightConsolidation(i,t,e,n,r,f),v=Math.min(c,l,g,d,p)
i[n][r]=v}return i[t.length][e.length]},weightSubstitution:function(t,e,n,i){var r=this.weightInterval(t[n-1],e[i-1]),a=this.weightLength(t[n-1].duration,e[i-1].duration),s=r+this.globalK*a
return s},weightInsertion:function(t,e){return this.globalK*t[e-1].duration},weightDeletion:function(t,e){return this.globalK*t[e-1].duration},weightFragmentation:function(t,e,n,i,r,a){var s,u,h=2,o=Math.min(r-1,a),f=1/0
for(s=h;o>=s;s++){u=s
for(var c=t[i-1][r-u],l=0;u>0;){var g=this.weightInterval(e[i-1],n[r-u])
c+=g,l+=n[r-u].duration,u--}var d=this.weightLength(e[i-1].duration,l)
c+=this.globalK*d,f>c&&(f=c)}return f},weightConsolidation:function(t,e,n,i,r,a){var s,u,h=2,o=Math.min(i-1,a),f=1/0
for(s=h;o>=s;s++){u=s
for(var c=t[i-u][r-1],l=0;u>0;){var g=this.weightInterval(e[i-u],n[r-1])
c+=g,l+=e[i-u].duration,u--}var d=this.weightLength(l,n[r-1].duration)
c+=this.globalK*d,f>c&&(f=c)}return f},weightInterval:function(t,e){if("true"===t.rest||t.rest===!0||"true"===e.rest||e.rest===!0)return.1
var n=t.value%12
0===n&&(n=12)
var i=e.value%12
if(0===i&&(i=12),"undefined"!=typeof this.base12Inverted[n]&&"undefined"!=typeof this.base12Inverted[i]){var r=this.degreesFromSemitones[n],a=this.degreesFromSemitones[i]
return this.deg[Math.abs(r-a)]}return this.ton[Math.abs(n-i)]},weightLength:function(t,e){return Math.abs(t-e)},distanceParsons:function(t,e){var n=this.parsons(this.notes(t,!1,!1))
return this.stringEditDistance(n.map(function(t){return t.value}).join(""),e)},distancePitch:function(t,e){var n=parseInt(t.attributes.key.fifths),i=this.notes(t,!1,!1)
return this.arrayEditDistance(this.pitchValues(i,n),e)},distanceIntervals:function(t,e){var n=this.intervals(this.notes(t,!1,!1))
return this.arrayEditDistance(n.map(function(t){return t.value}),e)},distancePitchDuration:function(t,e){var n=parseInt(t.attributes.key.fifths),i=this.notes(t,!1,!0)
return this.weightedEditDistance(this.pitchDurationValues(i,n,parseInt(t.attributes.divisions),parseInt(t.attributes.time["beat-type"])),e)},distanceParsonsNgrams:function(t,e){for(var n=this.ngrams(this.parsons(this.notes(t,!1,!1)),e.length),i=[],r=0;r<n.length;r++){for(var a=0;a<n[r].length;a++)0===a&&(n[r][a].value="*")
i.push({distance:this.stringEditDistance(n[r].map(function(t){return t.value}).join(""),e),highlight:this.highlightMapping(n[r])})}return i},distancePitchNgrams:function(t,e){for(var n=parseInt(t.attributes.key.fifths),i=this.ngrams(this.notes(t,!1,!1),e.length),r=[],a=0;a<i.length;a++)r.push({distance:this.arrayEditDistance(this.pitchValues(i[a],n),e),highlight:this.highlightMapping(i[a])})
return r},distanceIntervalsNgrams:function(t,e){for(var n=this.ngrams(this.intervals(this.notes(t,!1,!1)),e.length),i=[],r=0;r<n.length;r++){for(var a=0;a<n[r].length;a++)0===a&&(n[r][a].value="*")
i.push({distance:this.arrayEditDistance(n[r].map(function(t){return t.value}),e),highlight:this.highlightMapping(n[r])})}return i},distancePitchDurationNgrams:function(t,e){for(var n=parseInt(t.attributes.divisions),i=parseInt(t.attributes.time["beat-type"]),r=parseInt(t.attributes.key.fifths),a=this.ngrams(this.notes(t,!1,!0),e.length),s=[],u=0;u<a.length;u++)s.push({distance:this.weightedEditDistance(this.pitchDurationValues(a[u],r,n,i),e),highlight:this.highlightMapping(a[u])})
return s}}
"undefined"!=typeof define&&null!==define&&define.amd?define(function(){return t}):"undefined"!=typeof module&&null!==module?module.exports=t:"undefined"!=typeof self&&"function"==typeof self.postMessage&&"function"==typeof self.importScripts?self.MusicJsonToolbox=t:"undefined"!=typeof window&&null!==window&&(window.MusicJsonToolbox=t)}()
