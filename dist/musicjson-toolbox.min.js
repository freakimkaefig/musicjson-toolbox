!function(){"use strict"
var t={base12:{C:1,D:3,E:5,F:6,G:8,A:10,B:12},base12Inverted:{1:"C",3:"D",5:"E",6:"F",8:"G",10:"A",12:"B"},degreesFromSemitones:{1:1,3:2,5:3,6:4,8:5,10:6,12:7},deg:{0:0,1:.9,2:.2,3:.5,4:.1,5:.35,6:.8},ton:{0:.6,1:2.6,2:2.3,3:1,4:1,5:1.6,6:1.8,7:.8,8:1.3,9:1.3,10:2.2,11:2.5},globalK:.348,abcStep:["C,,,","^C,,,","D,,,","^D,,,","E,,,","F,,,","^F,,,","G,,,","^G,,,","A,,,","^A,,,","B,,,","C,,","^C,,","D,,","^D,,","E,,","F,,","^F,,","G,,","^G,,","A,,","^A,,","B,,","C,","^C,","D,","^D,","E,","F,","^F,","G,","^G,","A,","^A,","B,","C","^C","D","^D","E","F","^F","G","^G","A","^A","B","c","^c","d","^d","e","f","^f","g","^g","a","^a","b","c'","^c'","d'","^d'","e'","f'","^f'","g'","^g'","a'","^a'","b'","c''","^c''","d''","^d''","e''","f''","^f''","g''","^g''","a''","^a''","b''","c'''","^c'''","d'''","^d'''","e'''","f'''","^f'''","g'''","^g'''","a'''","^a'''","b'''"],abcAccidental:{"flat-flat":"__",flat:"_",natural:"=",sharp:"^","sharp-sharp":"^^",undefined:"","":""},notes:function(t,e,i){for(var n=[],r=-1,a=0;a<t.measures.length;a++){for(var s=0;s<t.measures[a].notes.length;s++)t.measures[a].notes[s].measureNumber=a,t.measures[a].notes[s].noteNumber=s
if(e&&t.measures[a].attributes.repeat.left&&(r=a),n=n.concat(t.measures[a].notes),e&&t.measures[a].attributes.repeat.right){if(-1!==r)for(;a>=r;)n=n.concat(t.measures[r].notes),r++
r=-1}}for(var u=0;u<n.length;u++)n[u].rest!==!0&&"true"!==n[u].rest||i!==!1||n.splice(u,1)
return n},intervals:function(t){var e=[]
e.push({value:"*",duration:"*",noteNumber:0,measureNumber:0})
for(var i=1;i<t.length;i++){var n=this.pitchDifference(t[i-1].pitch,0,t[i].pitch,!0,!1),r={value:n,duration:this.durationDifference(t[i-1].duration,t[i].duration),noteNumber:t[i].noteNumber,measureNumber:t[i].measureNumber}
e.push(r)}return e},parsons:function(t){var e=[]
e.push({value:"*",noteNumber:0,measureNumber:0})
for(var i=1;i<t.length;i++){var n,r=this.pitchDifference(t[i-1].pitch,0,t[i].pitch,!0,!1)
0===r?n="r":r>0?n="u":0>r&&(n="d"),e.push({value:n,noteNumber:t[i].noteNumber,measureNumber:t[i].measureNumber})}return e},ngrams:function(t,e){for(var i=[],n=0;n<t.length-(e-1);n++){for(var r=[],a=0;e>a;a++)r.push(t[n+a])
i.push(r)}return i},pitchValues:function(t,e){return t.map(function(t){return this.base12Pitch(t.pitch.step,e,t.pitch.octave,t.pitch.alter,!1)}.bind(this))},pitchDurationValues:function(t,e,i,n){return t.map(function(t){return{value:this.base12Pitch(t.pitch.step,e,t.pitch.octave,t.pitch.alter,!1),rest:t.rest,duration:t.duration/i/n*16}}.bind(this))},tempoAdjust:function(t,e){for(var i=[],n=0;n<t.length;n++){var r=t[n]
r.duration=e(r.duration),i.push(r)}return i},valueMapping:function(t){return t.map(function(t){return t.value})},highlightMapping:function(t){return t.map(function(t){return{measure:t.measureNumber,note:t.noteNumber}})},base12Pitch:function(t,e,i,n,r){var a=this.base12[t]
if(n&&(a+=n),0>e)for(a-=12*Math.round(Math.abs(e)/2);0>e;)a+=7,e++
else for(a+=12*Math.round(Math.abs(e)/2);e>0;)a-=7,e--
if(0===a&&(a=12,i--),r)a+=12*i
else{for(;a>12;)a-=12
for(;0>a;)a+=12}return a},interval2AbcStep:function(t,e){return this.abcStep[e+t-13]},pitchDuration2AbcStep:function(t,e){var i=this.abcAccidental[t.pitch.accidental],n=this.abcStep[this.base12Pitch(t.pitch.step,0,t.pitch.octave,0,!0)-13],r=t.duration
null!==e&&e.dot&&(r=2*r)
var a=""
return t.dot&&(r/=1.5,a=">"),t.rest?"z"+r+a:i+n+r+a},pitchDifference:function(t,e,i,n,r){"undefined"==typeof n&&(n=!1),"undefined"==typeof r&&(r=!1)
var a=this.base12Pitch(i.step,e,parseInt(i.octave),parseInt(i.alter),n)-this.base12Pitch(t.step,e,parseInt(t.octave),parseInt(t.alter),n)
return r&&(a=Math.abs(a)),a},durationDifference:function(t,e,i){"undefined"==typeof i&&(i=!1)
var n=e-t
return i&&(n=Math.abs(n)),n},uniques:function(t){for(var e=[],i=0,n=t.length;n>i;i++)-1===e.indexOf(t[i])&&""!==t[i]&&e.push(t[i])
return e},editDistance:function(t,e,i,n){if(0===t.length)return e.length
if(0===e.length)return t.length
var r,a=[]
for(r=0;r<=e.length;r++)a[r]=[r]
var s
for(s=0;s<=t.length;s++)a[0][s]=s
for(r=1;r<=e.length;r++)for(s=1;s<=t.length;s++)i(r,s)?a[r][s]=a[r-1][s-1]:a[r][s]=Math.min(a[r-1][s-1]+n(r,s),a[r][s-1]+n(r,s),a[r-1][s]+n(r,s))
return a[e.length][t.length]},stringEditDistance:function(t,e){return this.editDistance(t,e,function(i,n){return e.charAt(i-1)===t.charAt(n-1)},function(){return 1})},arrayEditDistance:function(t,e){return this.editDistance(t,e,function(i,n){return e[i-1]===t[n-1]},function(){return 1})},weightedEditDistance:function(t,e){var i,n=[]
for(i=0;i<=t.length;i++)i>0?n[i]=[parseFloat(n[i-1])+this.weightDeletion(t,i)]:n[i]=[i]
var r
for(r=0;r<=e.length;r++)r>0?n[0][r]=parseFloat(n[0][r-1])+this.weightInsertion(e,r):n[0][r]=r
var a=0,s=1/0
for(i=0;i<t.length;i++)a<t[i].duration&&(a=t[i].duration)
for(r=0;r<e.length;r++)s>e[r].duration&&(s=e[r].duration)
var u=a/s,h=0,o=1/0
for(r=0;r<e.length;r++)h<e[r].duration&&(h=e[r].duration)
for(i=0;i<t.length;i++)o>t[i].duration&&(o=t[i].duration)
var c=h/o
for(i=1;i<=t.length;i++)for(r=1;r<=e.length;r++)if(t[i-1].value===e[r-1].value&&t[i-1].rest===e[r-1].rest&&t[i-1].duration===e[r-1].duration)n[i][r]=n[i-1][r-1]
else{var f=n[i-1][r-1]+this.weightSubstitution(t,e,i,r),l=n[i][r-1]+this.weightInsertion(e,r),g=n[i-1][r]+this.weightDeletion(t,i),d=this.weightFragmentation(n,t,e,i,r,u),p=this.weightConsolidation(n,t,e,i,r,c),v=Math.min(f,l,g,d,p)
n[i][r]=v}return n[t.length][e.length]},weightSubstitution:function(t,e,i,n){var r=this.weightInterval(t[i-1],e[n-1]),a=this.weightLength(t[i-1].duration,e[n-1].duration),s=r+this.globalK*a
return s},weightInsertion:function(t,e){return this.globalK*t[e-1].duration},weightDeletion:function(t,e){return this.globalK*t[e-1].duration},weightFragmentation:function(t,e,i,n,r,a){var s,u,h=2,o=Math.min(r-1,a),c=1/0
for(s=h;o>=s;s++){u=s
for(var f=t[n-1][r-u],l=0;u>0;){var g=this.weightInterval(e[n-1],i[r-u])
f+=g,l+=i[r-u].duration,u--}var d=this.weightLength(e[n-1].duration,l)
f+=this.globalK*d,c>f&&(c=f)}return c},weightConsolidation:function(t,e,i,n,r,a){var s,u,h=2,o=Math.min(n-1,a),c=1/0
for(s=h;o>=s;s++){u=s
for(var f=t[n-u][r-1],l=0;u>0;){var g=this.weightInterval(e[n-u],i[r-1])
f+=g,l+=e[n-u].duration,u--}var d=this.weightLength(l,i[r-1].duration)
f+=this.globalK*d,c>f&&(c=f)}return c},weightInterval:function(t,e){if("true"===t.rest||t.rest===!0||"true"===e.rest||e.rest===!0)return.1
var i=t.value%12
0===i&&(i=12)
var n=e.value%12
if(0===n&&(n=12),"undefined"!=typeof this.base12Inverted[i]&&"undefined"!=typeof this.base12Inverted[n]){var r=this.degreesFromSemitones[i],a=this.degreesFromSemitones[n]
return this.deg[Math.abs(r-a)]}return this.ton[Math.abs(i-n)]},weightLength:function(t,e){return Math.abs(t-e)},distanceParsons:function(t,e){return this.stringEditDistance(this.valueMapping(this.parsons(this.notes(t,!1,!1))).join(""),e)},parsonSimilarity:function(t,e){return this.distanceParsons(t,this.valueMapping(this.parsons(this.notes(e,!1,!1))).join(""))},distancePitch:function(t,e){return this.arrayEditDistance(this.pitchValues(this.notes(t,!1,!1),parseInt(t.attributes.key.fifths)),e)},pitchSimilarity:function(t,e){return this.distancePitch(t,this.pitchValues(this.notes(e,!1,!1),parseInt(e.attributes.key.fifths)))},distanceIntervals:function(t,e){return this.arrayEditDistance(this.valueMapping(this.intervals(this.notes(t,!1,!1))),e)},intervalSimilarity:function(t,e){return this.distanceIntervals(t,this.valueMapping(this.intervals(this.notes(e,!1,!1))))},distancePitchDuration:function(t,e){return this.weightedEditDistance(this.pitchDurationValues(this.notes(t,!1,!0),parseInt(t.attributes.key.fifths),parseInt(t.attributes.divisions),parseInt(t.attributes.time["beat-type"])),e)},pitchDurationSimilarity:function(t,e){return this.distancePitchDuration(t,this.pitchDurationValues(this.notes(e,!1,!0),parseInt(e.attributes.key.fifths),parseInt(e.attributes.divisions),parseInt(e.attributes.time["beat-type"])))},distanceParsonsNgrams:function(t,e){for(var i=this.ngrams(this.parsons(this.notes(t,!1,!1)),e.length),n=[],r=0;r<i.length;r++){for(var a=0;a<i[r].length;a++)0===a&&(i[r][a].value="*")
n.push({distance:this.stringEditDistance(this.valueMapping(i[r]).join(""),e),highlight:this.highlightMapping(i[r])})}return n},distancePitchNgrams:function(t,e){for(var i=parseInt(t.attributes.key.fifths),n=this.ngrams(this.notes(t,!1,!1),e.length),r=[],a=0;a<n.length;a++)r.push({distance:this.arrayEditDistance(this.pitchValues(n[a],i),e),highlight:this.highlightMapping(n[a])})
return r},distanceIntervalsNgrams:function(t,e){for(var i=this.ngrams(this.intervals(this.notes(t,!1,!1)),e.length),n=[],r=0;r<i.length;r++){for(var a=0;a<i[r].length;a++)0===a&&(i[r][a].value="*")
n.push({distance:this.arrayEditDistance(this.valueMapping(i[r]),e),highlight:this.highlightMapping(i[r])})}return n},distancePitchDurationNgrams:function(t,e){for(var i=parseInt(t.attributes.divisions),n=parseInt(t.attributes.time["beat-type"]),r=parseInt(t.attributes.key.fifths),a=this.ngrams(this.notes(t,!1,!0),e.length),s=[],u=0;u<a.length;u++)s.push({distance:this.weightedEditDistance(this.pitchDurationValues(a[u],r,i,n),e),highlight:this.highlightMapping(a[u])})
return s}}
"undefined"!=typeof define&&null!==define&&define.amd?define(function(){return t}):"undefined"!=typeof module&&null!==module?module.exports=t:"undefined"!=typeof self&&"function"==typeof self.postMessage&&"function"==typeof self.importScripts?self.MusicJsonToolbox=t:"undefined"!=typeof window&&null!==window&&(window.MusicJsonToolbox=t)}()
